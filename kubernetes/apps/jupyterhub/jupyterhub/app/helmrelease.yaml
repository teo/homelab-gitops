---
# yaml-language-server: $schema=https://raw.githubusercontent.com/fluxcd-community/flux2-schemas/main/helmrepository-source-v1.json
apiVersion: source.toolkit.fluxcd.io/v1
kind: HelmRepository
metadata:
  name: jupyterhub
  namespace: jupyterhub
  annotations:
    fluxcd.io/redeploy: "2026-02-09T21:50:00"
spec:
  interval: 12h
  url: https://hub.jupyter.org/helm-chart/
---
# yaml-language-server: $schema=https://raw.githubusercontent.com/fluxcd-community/flux2-schemas/main/helmrelease-helm-v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: jupyterhub
  namespace: jupyterhub
spec:
  interval: 3m

  chart:
    spec:
      chart: jupyterhub
      version: 4.3.2
      sourceRef:
        kind: HelmRepository
        name: jupyterhub
        namespace: jupyterhub
      interval: 12h

  # Private repo can provide cluster-specific config & secrets.
  valuesFrom:
    - kind: ConfigMap
      name: jupyterhub-values
      optional: true
    - kind: Secret
      name: jupyterhub-secrets
      optional: true

  values:
    hub:
      db:
        pvc:
          storageClassName: zfs-configuration

    proxy:
      service:
        type: ClusterIP

    ingress:
      enabled: false

    cull:
      enabled: true
      timeout: 3600   # 1h idle
      every: 600      # check every 10 min      

    singleuser:
      cpu:
        guarantee: 2
        limit: 8
      memory:
        guarantee: 8G
        limit: 32G
      
      networkPolicy:
        enabled: true
      
      defaultUrl: /lab
      
      storage:
        type: static
        capacity: 50Gi
        static:
          pvcName: jupyterhub-users-pvc
      
        extraVolumes:
          - name: dshm
            emptyDir:
              medium: Memory
              sizeLimit: 4Gi
        extraVolumeMounts:
          - name: dshm
            mountPath: /dev/shm

      image:
        name: quay.io/jupyter/scipy-notebook
        tag: python-3.13
      cmd: jupyter-labhub
      
      profileList:
        - display_name: "CPU scipy-notebook"
          default: true
          description: "General data science notebook server (no GPU)."
        - display_name: "GPU pytorch-notebook (1 slice)"
          description: "CUDA + PyTorch, requests 1 GPU slot."
          kubespawner_override:
            extra_resource_limits:
              nvidia.com/gpu: "1"
            extra_pod_config:
              runtimeClassName: nvidia
            image: quay.io/jupyter/pytorch-notebook:cuda12-python-3.13
            cpu_guarantee: 4
            cpu_limit: 12
            mem_guarantee: 16G
            mem_limit: 48G